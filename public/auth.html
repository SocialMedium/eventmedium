<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign in — Event Medium</title>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root {
  --accent:#6366f1;--accent2:#4f46e5;--accent-light:rgba(99,102,241,0.08);
  --bg:#f8f8fa;--card:#ffffff;
  --txt:#1a1a2e;--txtL:#555;--txtXL:#999;
  --bdr:rgba(0,0,0,0.08);--bdr2:rgba(0,0,0,0.12);
  --err:#dc2626;--errL:rgba(220,38,38,0.08);
  --ok:#059669;--okL:rgba(5,150,105,0.08);
  --shadow:0 1px 3px rgba(0,0,0,0.06);
  --shadowL:0 10px 25px rgba(0,0,0,0.08);
  --sans:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  --mono:ui-monospace,SFMono-Regular,Menlo,monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--sans);color:var(--txt);background:var(--bg);min-height:100vh;display:flex;flex-direction:column;-webkit-font-smoothing:antialiased}

.nav{background:rgba(255,255,255,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--bdr);padding:0 24px}
.nav-inner{max-width:1140px;margin:0 auto;display:flex;align-items:center;height:64px}
.nav-brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--txt);font-size:14px;font-weight:700}
.nav-dot{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent2))}

.auth-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 24px}
.auth-card{background:var(--card);border-radius:16px;border:1px solid var(--bdr);box-shadow:var(--shadowL);padding:40px;width:100%;max-width:420px}
.auth-title{font-size:24px;font-weight:700;text-align:center;margin-bottom:4px}
.auth-sub{font-size:14px;color:var(--txtL);text-align:center;margin-bottom:28px}

/* OAuth */
.oauth-buttons{display:flex;flex-direction:column;gap:10px;margin-bottom:24px}
.oauth-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;border:1px solid var(--bdr2);border-radius:10px;background:var(--card);color:var(--txt);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;min-height:44px;font-family:var(--sans)}
.oauth-btn:hover{border-color:var(--accent);background:var(--accent-light)}
.oauth-btn svg{width:20px;height:20px;flex-shrink:0}

.divider{display:flex;align-items:center;gap:16px;margin-bottom:24px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bdr2)}
.divider span{font-size:12px;color:var(--txtXL);font-weight:500;text-transform:uppercase}

/* Form */
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;font-weight:600;color:var(--txt);margin-bottom:6px}
.form-input{width:100%;padding:12px 14px;border:1px solid var(--bdr2);border-radius:10px;font-size:14px;font-family:var(--sans);transition:all 0.2s;background:var(--card);color:var(--txt);min-height:44px}
.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}
.form-input::placeholder{color:var(--txtXL)}

.btn-primary{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:var(--sans);min-height:44px}
.btn-primary:hover{opacity:0.9;transform:translateY(-1px)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}

.btn-ghost{width:100%;padding:12px;background:transparent;color:var(--txtL);border:1px solid var(--bdr2);border-radius:10px;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;font-family:var(--sans);margin-top:12px}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}

/* Code input */
.code-row{display:flex;gap:8px;justify-content:center;margin-bottom:20px}
.code-digit{width:48px;height:56px;border:2px solid var(--bdr2);border-radius:10px;text-align:center;font-size:24px;font-weight:700;font-family:var(--mono);color:var(--accent);background:var(--card);transition:all 0.2s}
.code-digit:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}

/* Messages */
.auth-msg{padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none}
.auth-msg.error{background:var(--errL);color:var(--err);display:block}
.auth-msg.success{background:var(--okL);color:var(--ok);display:block}

/* States */
.loading{text-align:center;padding:60px 24px;color:var(--txtL);font-size:15px}
.hidden{display:none!important}

/* Timer */
.timer{text-align:center;font-size:13px;color:var(--txtL);margin-bottom:16px}
.timer strong{color:var(--accent);font-family:var(--mono)}

/* Tabs */
.auth-tabs{display:flex;gap:0;margin-bottom:24px;border:1px solid var(--bdr2);border-radius:10px;overflow:hidden}
.auth-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:600;cursor:pointer;background:var(--card);color:var(--txtL);border:none;font-family:var(--sans);transition:all 0.2s}
.auth-tab.active{background:var(--accent);color:white}
.auth-tab:hover:not(.active){background:var(--accent-light);color:var(--accent)}

@media(max-width:640px){
  .auth-card{padding:28px 20px}
  .code-digit{width:42px;height:50px;font-size:20px}
}
</style>
<link rel="stylesheet" href="/css/nav.css">
</head>
<body>

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">
      <div class="nav-dot"></div>
      Event <span style="color:var(--accent)">Medium</span>
    </a>
  </div>
</nav>

<div class="loading hidden" id="tokenCapture">Signing you in...</div>

<div class="auth-wrap" id="authWrap">
  <div class="auth-card">
    <h1 class="auth-title" id="authTitle">Sign in</h1>
    <p class="auth-sub" id="authSub">Get matched with the right people at events</p>

    <div id="authMsg" class="auth-msg"></div>

    <!-- ══ STEP 1: Email entry ══ -->
    <div id="step1">
      <div class="oauth-buttons">
        <a href="/api/auth/google" class="oauth-btn">
          <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A10.96 10.96 0 0 0 1 12c0 1.77.42 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Continue with Google
        </a>
        <a href="/api/auth/linkedin" class="oauth-btn">
          <svg viewBox="0 0 24 24" fill="#0A66C2"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
          Continue with LinkedIn
        </a>
      </div>

      <div class="divider"><span>or use email</span></div>

      <div class="form-group">
        <label class="form-label">Email address</label>
        <input type="email" class="form-input" id="emailInput" placeholder="you@company.com" autocomplete="email" required>
      </div>
      <button class="btn-primary" id="sendCodeBtn" onclick="sendMagicCode()">Send sign-in code</button>

      <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--txtXL)">
        Works with any email — no OAuth required.<br>Corporate, personal, whatever you use.
      </div>

      <button class="btn-ghost" onclick="showPasswordMode()">Sign in with password instead</button>
    </div>

    <!-- ══ STEP 2: Code verification ══ -->
    <div id="step2" class="hidden">
      <div style="text-align:center;margin-bottom:20px">
        <div style="font-size:13px;color:var(--txtL)">We sent a 6-digit code to</div>
        <div style="font-size:15px;font-weight:600;color:var(--accent);margin-top:4px" id="sentToEmail"></div>
      </div>

      <div class="code-row">
        <input type="text" maxlength="1" class="code-digit" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code">
        <input type="text" maxlength="1" class="code-digit" inputmode="numeric" pattern="[0-9]">
        <input type="text" maxlength="1" class="code-digit" inputmode="numeric" pattern="[0-9]">
        <input type="text" maxlength="1" class="code-digit" inputmode="numeric" pattern="[0-9]">
        <input type="text" maxlength="1" class="code-digit" inputmode="numeric" pattern="[0-9]">
        <input type="text" maxlength="1" class="code-digit" inputmode="numeric" pattern="[0-9]">
      </div>

      <div class="timer" id="timer">Code expires in <strong id="timerCount">10:00</strong></div>

      <button class="btn-primary" id="verifyBtn" onclick="verifyCode()" disabled>Verify code</button>

      <button class="btn-ghost" onclick="showStep1()">← Use a different email</button>

      <div style="text-align:center;margin-top:12px">
        <button style="background:none;border:none;color:var(--txtXL);font-size:12px;cursor:pointer;font-family:var(--sans);text-decoration:underline" id="resendBtn" onclick="sendMagicCode()">Resend code</button>
      </div>
    </div>

    <!-- ══ STEP 3: Password mode (fallback) ══ -->
    <div id="step3" class="hidden">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabLogin" onclick="setPasswordMode(false)">Sign in</button>
        <button class="auth-tab" id="tabSignup" onclick="setPasswordMode(true)">Sign up</button>
      </div>

      <form id="loginForm" onsubmit="handlePasswordAuth(event)">
        <div class="form-group hidden" id="nameGroup">
          <label class="form-label">Full name</label>
          <input type="text" class="form-input" id="nameInput" placeholder="Your name" autocomplete="name">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="pwEmailInput" placeholder="you@example.com" autocomplete="email" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="passwordInput" placeholder="At least 8 characters" autocomplete="current-password" required>
        </div>
        <button type="submit" class="btn-primary" id="pwSubmitBtn">Sign in</button>
      </form>

      <button class="btn-ghost" onclick="showStep1()">← Back to email code</button>
    </div>
  </div>
</div>

<script>
var magicEmail = '';
var isSignup = false;
var timerInterval = null;

// ── Step navigation ──
function showStep1() {
  hideMsg();
  document.getElementById('step1').classList.remove('hidden');
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.add('hidden');
  document.getElementById('authTitle').textContent = 'Sign in';
  document.getElementById('authSub').textContent = 'Get matched with the right people at events';
  if (timerInterval) clearInterval(timerInterval);
}

function showStep2() {
  hideMsg();
  document.getElementById('step1').classList.add('hidden');
  document.getElementById('step2').classList.remove('hidden');
  document.getElementById('step3').classList.add('hidden');
  document.getElementById('authTitle').textContent = 'Enter your code';
  document.getElementById('authSub').textContent = 'Check your inbox — it may take a moment';
  // Focus first digit
  var digits = document.querySelectorAll('.code-digit');
  digits.forEach(function(d) { d.value = ''; });
  setTimeout(function() { digits[0].focus(); }, 100);
  startTimer();
}

function showPasswordMode() {
  hideMsg();
  document.getElementById('step1').classList.add('hidden');
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');
  document.getElementById('authTitle').textContent = 'Sign in with password';
  document.getElementById('authSub').textContent = 'For accounts created with email + password';
}

function setPasswordMode(signup) {
  isSignup = signup;
  document.getElementById('tabLogin').classList.toggle('active', !signup);
  document.getElementById('tabSignup').classList.toggle('active', signup);
  document.getElementById('nameGroup').classList.toggle('hidden', !signup);
  document.getElementById('pwSubmitBtn').textContent = signup ? 'Create account' : 'Sign in';
  document.getElementById('passwordInput').autocomplete = signup ? 'new-password' : 'current-password';
}

// ── Messages ──
function showMsg(text, type) {
  var el = document.getElementById('authMsg');
  el.textContent = text;
  el.className = 'auth-msg ' + type;
}
function hideMsg() { document.getElementById('authMsg').className = 'auth-msg'; }

// ── Timer ──
function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  var seconds = 600; // 10 min
  var el = document.getElementById('timerCount');
  timerInterval = setInterval(function() {
    seconds--;
    if (seconds <= 0) { clearInterval(timerInterval); el.textContent = 'expired'; return; }
    var m = Math.floor(seconds / 60);
    var s = seconds % 60;
    el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
  }, 1000);
}

// ── Magic code: send ──
async function sendMagicCode() {
  hideMsg();
  var email = document.getElementById('emailInput').value.trim();
  if (!email || !email.includes('@')) {
    showMsg('Enter a valid email address', 'error');
    return;
  }

  var btn = document.getElementById('sendCodeBtn');
  btn.disabled = true;
  btn.textContent = 'Sending...';

  try {
    var resp = await fetch('/api/auth/magic-send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    });
    var data = await resp.json();

    if (!resp.ok) {
      showMsg(data.error || 'Failed to send code', 'error');
      btn.disabled = false;
      btn.textContent = 'Send sign-in code';
      return;
    }

    magicEmail = email;
    document.getElementById('sentToEmail').textContent = email;
    showStep2();
  } catch (err) {
    showMsg('Connection error — try again', 'error');
  }
  btn.disabled = false;
  btn.textContent = 'Send sign-in code';
}

// ── Code digit inputs: auto-advance + paste support ──
(function() {
  var digits = document.querySelectorAll('.code-digit');

  digits.forEach(function(input, i) {
    input.addEventListener('input', function(e) {
      var val = input.value.replace(/\D/g, '');
      input.value = val.substring(0, 1);
      if (val && i < digits.length - 1) digits[i + 1].focus();
      checkCodeComplete();
    });

    input.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace' && !input.value && i > 0) {
        digits[i - 1].focus();
        digits[i - 1].value = '';
      }
      if (e.key === 'Enter') verifyCode();
    });

    // Handle paste of full code
    input.addEventListener('paste', function(e) {
      e.preventDefault();
      var pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
      if (pasted.length >= 6) {
        for (var j = 0; j < 6; j++) {
          digits[j].value = pasted[j] || '';
        }
        digits[5].focus();
        checkCodeComplete();
      }
    });
  });

  function checkCodeComplete() {
    var code = '';
    digits.forEach(function(d) { code += d.value; });
    document.getElementById('verifyBtn').disabled = code.length < 6;
    if (code.length === 6) verifyCode();
  }
})();

// ── Magic code: verify ──
async function verifyCode() {
  hideMsg();
  var digits = document.querySelectorAll('.code-digit');
  var code = '';
  digits.forEach(function(d) { code += d.value; });

  if (code.length < 6) {
    showMsg('Enter the full 6-digit code', 'error');
    return;
  }

  var btn = document.getElementById('verifyBtn');
  btn.disabled = true;
  btn.textContent = 'Verifying...';

  try {
    var resp = await fetch('/api/auth/magic-verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: magicEmail, code: code })
    });
    var data = await resp.json();

    if (!resp.ok) {
      showMsg(data.error || 'Invalid code — check and try again', 'error');
      btn.disabled = false;
      btn.textContent = 'Verify code';
      // Clear digits
      digits.forEach(function(d) { d.value = ''; });
      digits[0].focus();
      return;
    }

    // Success!
    localStorage.setItem('auth_token', data.token);
    showMsg('Signed in! Redirecting...', 'success');
    handlePostAuth(data.token);
  } catch (err) {
    showMsg('Connection error — try again', 'error');
    btn.disabled = false;
    btn.textContent = 'Verify code';
  }
}

// ── Password auth ──
async function handlePasswordAuth(e) {
  e.preventDefault();
  hideMsg();
  var btn = document.getElementById('pwSubmitBtn');
  btn.disabled = true;
  btn.textContent = isSignup ? 'Creating...' : 'Signing in...';

  var email = document.getElementById('pwEmailInput').value.trim();
  var password = document.getElementById('passwordInput').value;
  var name = document.getElementById('nameInput').value.trim();

  if (isSignup && !name) {
    showMsg('Enter your name', 'error');
    btn.disabled = false;
    btn.textContent = 'Create account';
    return;
  }

  try {
    var url = isSignup ? '/api/auth/signup' : '/api/auth/login';
    var body = isSignup ? { name: name, email: email, password: password } : { email: email, password: password };

    var resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    var data = await resp.json();

    if (!resp.ok) {
      showMsg(data.error || 'Something went wrong', 'error');
      btn.disabled = false;
      btn.textContent = isSignup ? 'Create account' : 'Sign in';
      return;
    }

    localStorage.setItem('auth_token', data.token);
    handlePostAuth(data.token);
  } catch (err) {
    showMsg('Connection error', 'error');
    btn.disabled = false;
    btn.textContent = isSignup ? 'Create account' : 'Sign in';
  }
}

// ── Post-auth routing ──
async function handlePostAuth(token) {
  try {
    var resp = await fetch('/api/stakeholder/profile', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    var data = await resp.json();
    if (data.profile && data.profile.stakeholder_type) {
      window.location.href = '/canister.html';
    } else {
      window.location.href = '/onboard.html';
    }
  } catch (err) {
    window.location.href = '/onboard.html';
  }
}

// ── OAuth token capture ──
(function() {
  var params = new URLSearchParams(window.location.search);
  var token = params.get('token');
  var error = params.get('error');

  if (error) {
    showMsg('OAuth sign-in failed — try email code instead', 'error');
    window.history.replaceState({}, '', '/auth.html');
    return;
  }
  if (token) {
    document.getElementById('authWrap').classList.add('hidden');
    document.getElementById('tokenCapture').classList.remove('hidden');
    localStorage.setItem('auth_token', token);
    window.history.replaceState({}, '', '/auth.html');
    handlePostAuth(token);
    return;
  }
  var existing = localStorage.getItem('auth_token');
  if (existing) {
    fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + existing } })
      .then(function(r) { if (r.ok) window.location.href = '/canister.html'; else localStorage.removeItem('auth_token'); })
      .catch(function() {});
  }
})();

lucide.createIcons();
</script>
<script src="/js/nav.js"></script>
</body>
</html>