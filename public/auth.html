<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign in — Event Medium</title>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root {
  --p: #0066ff;
  --pL: #e8f0fe;
  --pD: #0052cc;
  --s: #6c63ff;
  --ok: #00d084;
  --okL: #e6faf2;
  --bg: #f8f9fd;
  --card: #ffffff;
  --txt: #1a1d29;
  --txtL: #6b7280;
  --txtXL: #9ca3af;
  --bdr: #e5e7eb;
  --err: #ef4444;
  --errL: #fef2f2;
  --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadowL: 0 10px 25px rgba(0,0,0,0.08);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: var(--font); color: var(--txt); background: var(--bg);
  min-height: 100vh; display: flex; flex-direction: column;
  -webkit-font-smoothing: antialiased;
}

/* ── Nav ── */
.nav {
  background: rgba(255,255,255,0.92); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--bdr); padding: 0 24px;
}
.nav-inner {
  max-width: 1140px; margin: 0 auto;
  display: flex; align-items: center; height: 64px;
}
.nav-brand {
  display: flex; align-items: center; gap: 10px;
  text-decoration: none; color: var(--txt);
}
.nav-logo {
  width: 36px; height: 36px; background: var(--p); border-radius: 10px;
  display: flex; align-items: center; justify-content: center; color: white;
}
.nav-name { font-weight: 800; font-size: 1.15rem; letter-spacing: -0.3px; }

/* ── Auth container ── */
.auth-wrap {
  flex: 1; display: flex; align-items: center; justify-content: center;
  padding: 40px 24px;
}
.auth-card {
  background: var(--card); border-radius: 16px; border: 1px solid var(--bdr);
  box-shadow: var(--shadowL); padding: 40px; width: 100%; max-width: 420px;
}
.auth-title {
  font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 4px;
}
.auth-sub {
  font-size: 14px; color: var(--txtL); text-align: center; margin-bottom: 28px;
}

/* ── OAuth buttons ── */
.oauth-buttons { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
.oauth-btn {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 12px; border: 1px solid var(--bdr); border-radius: 10px;
  background: var(--card); color: var(--txt); font-size: 14px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; text-decoration: none;
  min-height: 44px;
}
.oauth-btn:hover { border-color: var(--p); background: var(--pL); }
.oauth-btn svg { width: 20px; height: 20px; flex-shrink: 0; }

/* ── Divider ── */
.divider {
  display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
}
.divider::before, .divider::after {
  content: ''; flex: 1; height: 1px; background: var(--bdr);
}
.divider span { font-size: 12px; color: var(--txtXL); font-weight: 500; text-transform: uppercase; }

/* ── Form ── */
.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-size: 13px; font-weight: 600; color: var(--txt);
  margin-bottom: 6px;
}
.form-input {
  width: 100%; padding: 12px 14px; border: 1px solid var(--bdr);
  border-radius: 10px; font-size: 14px; font-family: var(--font);
  transition: all 0.2s; background: var(--card); color: var(--txt);
  min-height: 44px;
}
.form-input:focus { outline: none; border-color: var(--p); box-shadow: 0 0 0 3px var(--pL); }
.form-input::placeholder { color: var(--txtXL); }

.form-submit {
  width: 100%; padding: 14px; background: var(--p); color: white;
  border: none; border-radius: 10px; font-size: 15px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; font-family: var(--font);
  min-height: 44px;
}
.form-submit:hover { background: var(--pD); }
.form-submit:disabled { opacity: 0.6; cursor: not-allowed; }

/* ── Toggle ── */
.auth-toggle {
  text-align: center; margin-top: 20px; font-size: 14px; color: var(--txtL);
}
.auth-toggle a {
  color: var(--p); font-weight: 600; text-decoration: none; cursor: pointer;
}
.auth-toggle a:hover { text-decoration: underline; }

/* ── Error/success ── */
.auth-msg {
  padding: 10px 14px; border-radius: 8px; font-size: 13px;
  margin-bottom: 16px; display: none;
}
.auth-msg.error { background: var(--errL); color: var(--err); display: block; }
.auth-msg.success { background: var(--okL); color: #059669; display: block; }

/* ── Loading ── */
.loading {
  text-align: center; padding: 60px 24px; color: var(--txtL); font-size: 15px;
}

/* ── Mobile ── */
@media (max-width: 640px) {
  .auth-card { padding: 28px 20px; }
  .nav-inner { padding: 0 16px; }
}
</style>
<link rel="stylesheet" href="/css/nav.css"></head>
<body>

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">
      <div class="nav-logo"><i data-lucide="radio" style="width:20px;height:20px;color:var(--p)"></i></div>
      <span class="nav-name">Event <span style="color:var(--p)">Medium</span></span>
    </a>
  </div>
</nav>

<!-- Token capture state (shown briefly during OAuth redirect) -->
<div class="loading" id="tokenCapture" style="display:none">
  Signing you in...
</div>

<!-- Auth form -->
<div class="auth-wrap" id="authWrap">
  <div class="auth-card">
    <h1 class="auth-title" id="authTitle">Welcome back</h1>
    <p class="auth-sub" id="authSub">Sign in to access your matches and events</p>

    <div id="authMsg" class="auth-msg"></div>

    <div class="oauth-buttons">
      <a href="/api/auth/google" class="oauth-btn">
        <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A10.96 10.96 0 0 0 1 12c0 1.77.42 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Continue with Google
      </a>
      <a href="/api/auth/linkedin" class="oauth-btn">
        <svg viewBox="0 0 24 24" fill="#0A66C2"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
        Continue with LinkedIn
      </a>
    </div>

    <div class="divider"><span>or</span></div>

    <!-- Login form (default) -->
    <form id="loginForm">
      <div class="form-group" id="nameGroup" style="display:none">
        <label class="form-label">Full name</label>
        <input type="text" class="form-input" id="nameInput" placeholder="Your name" autocomplete="name">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="emailInput" placeholder="you@example.com" autocomplete="email" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="passwordInput" placeholder="At least 8 characters" autocomplete="current-password" required>
      </div>
      <button type="submit" class="form-submit" id="submitBtn">Sign in</button>
    </form>

    <div class="auth-toggle">
      <span id="toggleText">Don't have an account?</span>
      <a id="toggleLink" onclick="toggleAuthMode()">Sign up</a>
    </div>
  </div>
</div>

<script>
var isSignup = false;

function toggleAuthMode() {
  isSignup = !isSignup;
  document.getElementById('authTitle').textContent = isSignup ? 'Create account' : 'Welcome back';
  document.getElementById('authSub').textContent = isSignup
    ? 'Sign up to start matching at events'
    : 'Sign in to access your matches and events';
  document.getElementById('nameGroup').style.display = isSignup ? 'block' : 'none';
  document.getElementById('submitBtn').textContent = isSignup ? 'Create account' : 'Sign in';
  document.getElementById('toggleText').textContent = isSignup ? 'Already have an account?' : "Don't have an account?";
  document.getElementById('toggleLink').textContent = isSignup ? 'Sign in' : 'Sign up';
  document.getElementById('passwordInput').autocomplete = isSignup ? 'new-password' : 'current-password';
  hideMsg();
}

function showMsg(text, type) {
  var el = document.getElementById('authMsg');
  el.textContent = text;
  el.className = 'auth-msg ' + type;
}
function hideMsg() {
  document.getElementById('authMsg').className = 'auth-msg';
}

// ── Form submit ──
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  hideMsg();
  var btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = isSignup ? 'Creating account...' : 'Signing in...';

  var email = document.getElementById('emailInput').value.trim();
  var password = document.getElementById('passwordInput').value;
  var name = document.getElementById('nameInput').value.trim();

  if (isSignup && !name) {
    showMsg('Please enter your name', 'error');
    btn.disabled = false;
    btn.textContent = 'Create account';
    return;
  }

  try {
    var url = isSignup ? '/api/auth/signup' : '/api/auth/login';
    var body = isSignup ? { name: name, email: email, password: password } : { email: email, password: password };

    var resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    var data = await resp.json();

    if (!resp.ok) {
      showMsg(data.error || 'Something went wrong', 'error');
      btn.disabled = false;
      btn.textContent = isSignup ? 'Create account' : 'Sign in';
      return;
    }

    // Store token and redirect
    localStorage.setItem('auth_token', data.token);
    handlePostAuth(data.token);
  } catch (err) {
    showMsg('Connection error. Please try again.', 'error');
    btn.disabled = false;
    btn.textContent = isSignup ? 'Create account' : 'Sign in';
  }
});

// ── Post-auth: check profile, route accordingly ──
async function handlePostAuth(token) {
  try {
    var resp = await fetch('/api/stakeholder/profile', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    var data = await resp.json();

    if (data.profile && data.profile.stakeholder_type) {
      // Returning user with profile → canister
      window.location.href = '/canister.html';
    } else {
      // New user → onboarding
      window.location.href = '/onboard.html';
    }
  } catch (err) {
    // Default to onboarding
    window.location.href = '/onboard.html';
  }
}

// ── OAuth token capture ──
// After OAuth callback, server redirects to /auth.html?token=xxx
(function() {
  var params = new URLSearchParams(window.location.search);
  var token = params.get('token');
  var error = params.get('error');

  if (error) {
    showMsg('OAuth sign-in failed. Please try again.', 'error');
    // Clean URL
    window.history.replaceState({}, '', '/auth.html');
    return;
  }

  if (token) {
    // Show loading state
    document.getElementById('authWrap').style.display = 'none';
    document.getElementById('tokenCapture').style.display = 'block';

    // Store token
    localStorage.setItem('auth_token', token);

    // Clean URL
    window.history.replaceState({}, '', '/auth.html');

    // Route based on profile status
    handlePostAuth(token);
    return;
  }

  // Already logged in? Redirect
  var existing = localStorage.getItem('auth_token');
  if (existing) {
    // Verify it's still valid
    fetch('/api/auth/me', {
      headers: { 'Authorization': 'Bearer ' + existing }
    }).then(function(r) {
      if (r.ok) window.location.href = '/canister.html';
      else localStorage.removeItem('auth_token');
    }).catch(function() {});
  }
})();

lucide.createIcons();
</script>
<script src="/js/nav.js"></script></body>
</html>