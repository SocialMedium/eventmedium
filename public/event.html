<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event — Event Medium</title>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root {
  --p: #0066ff;--pL: #e8f0fe;--pD: #0052cc;--s: #6c63ff;--ok: #00d084;
  --okL: #e6faf2;--warn: #f59e0b;--bg: #f8f9fd;--card: #ffffff;
  --txt: #1a1d29;--txtL: #6b7280;--txtXL: #9ca3af;--bdr: #e5e7eb;
  --shadow: 0 1px 3px rgba(0,0,0,0.06);--shadowL: 0 10px 25px rgba(0,0,0,0.08);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);color:var(--txt);background:var(--bg);-webkit-font-smoothing:antialiased}
.nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(255,255,255,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--bdr);padding:0 24px}
.nav-inner{max-width:1140px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px}
.nav-brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--txt)}
.nav-logo{width:36px;height:36px;background:var(--p);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white}
.nav-name{font-weight:800;font-size:1.15rem;letter-spacing:-0.3px}
.nav-back{display:flex;align-items:center;gap:6px;color:var(--txtL);text-decoration:none;font-size:14px;font-weight:500;padding:8px 16px;border-radius:8px;transition:all 0.2s}
.nav-back:hover{color:var(--txt);background:var(--card)}

.page{max-width:800px;margin:0 auto;padding:88px 24px 60px}

/* Hero card */
.event-hero{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:36px;margin-bottom:20px}
.event-hero h1{font-size:28px;font-weight:700;margin-bottom:16px;line-height:1.3}
.event-meta{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:16px}
.meta-item{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--txtL)}
.meta-item i{width:16px;height:16px;color:var(--p)}
.event-themes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px}
.theme-tag{padding:4px 12px;background:var(--pL);color:var(--p);font-size:12px;font-weight:600;border-radius:8px}
.event-desc{font-size:15px;color:var(--txtL);line-height:1.7;margin-bottom:24px;white-space:pre-line}
.event-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn-primary{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:var(--p);color:white;font-size:14px;font-weight:600;border-radius:10px;border:none;cursor:pointer;transition:all 0.2s;font-family:var(--font);text-decoration:none}
.btn-primary:hover{background:var(--pD);transform:translateY(-1px)}
.btn-primary.registered{background:var(--ok)}
.btn-primary.registered:hover{background:#00b872}
.btn-secondary{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:var(--card);color:var(--txt);font-size:14px;font-weight:600;border-radius:10px;border:1px solid var(--bdr);cursor:pointer;transition:all 0.2s;text-decoration:none;font-family:var(--font)}
.btn-secondary:hover{border-color:var(--p);color:var(--p)}
.btn-secondary i,.btn-primary i{width:16px;height:16px}
.attendee-count{font-size:14px;color:var(--txtL);display:flex;align-items:center;gap:6px}
.attendee-count i{width:16px;height:16px}

/* Countdown */
.countdown{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px;margin-bottom:20px;text-align:center}
.countdown-label{font-size:13px;color:var(--txtL);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:16px}
.countdown-grid{display:flex;justify-content:center;gap:20px}
.countdown-unit{text-align:center;min-width:72px}
.countdown-num{font-size:36px;font-weight:700;color:var(--p);line-height:1.1}
.countdown-txt{font-size:11px;color:var(--txtXL);font-weight:500;text-transform:uppercase;margin-top:4px}

/* Attendee breakdown */
.card{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px;margin-bottom:20px}
.card h2{font-size:17px;font-weight:700;margin-bottom:16px}
.type-bar{margin-bottom:12px}
.type-bar-header{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}
.type-bar-label{font-weight:600}
.type-bar-count{color:var(--txtL)}
.type-bar-track{height:8px;background:var(--bg);border-radius:4px;overflow:hidden}
.type-bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
.type-bar-fill.investor{background:var(--p)}
.type-bar-fill.founder{background:var(--ok)}
.type-bar-fill.researcher{background:var(--s)}
.type-bar-fill.corporate{background:#dc2626}
.type-bar-fill.advisor{background:var(--warn)}
.type-bar-fill.operator{background:#16a34a}
.type-bar-fill.other{background:var(--txtXL)}

/* Share */
.share-row{display:flex;gap:8px;flex-wrap:wrap}
.share-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:var(--bg);color:var(--txtL);border:1px solid var(--bdr);border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.2s;font-family:var(--font)}
.share-btn:hover{border-color:var(--p);color:var(--p);background:var(--pL)}
.share-btn i{width:14px;height:14px}

/* Nev CTA */
.nev-cta{background:linear-gradient(135deg,#0a1628,#1a2744);border-radius:16px;padding:28px 32px;margin-bottom:20px;color:white;display:flex;align-items:center;gap:20px}
.nev-cta-avatar{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--p),var(--s));display:flex;align-items:center;justify-content:center;flex-shrink:0}
.nev-cta h3{font-size:16px;font-weight:700;margin-bottom:4px}
.nev-cta p{font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:12px}
.nev-cta a{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;background:white;color:var(--txt);font-size:13px;font-weight:600;border-radius:8px;text-decoration:none;transition:all 0.2s}
.nev-cta a:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--txt);color:white;padding:12px 24px;border-radius:10px;font-size:14px;font-weight:500;z-index:300;transition:transform 0.3s;box-shadow:var(--shadowL)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{background:#059669}

.loading{text-align:center;padding:80px;color:var(--txtL)}

@media(max-width:640px){
  .page{padding:80px 16px 40px}
  .event-hero{padding:24px}
  .event-hero h1{font-size:22px}
  .event-meta{gap:12px}
  .event-actions{flex-direction:column}
  .event-actions > *{width:100%;justify-content:center}
  .countdown-num{font-size:28px}
  .countdown-grid{gap:12px}
  .nev-cta{flex-direction:column;text-align:center}
}
</style>
<link rel="stylesheet" href="/css/nav.css"></head>
<body>

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">
      <div class="nav-logo"><i data-lucide="radio" style="width:20px;height:20px;color:var(--p)"></i></div>
      <span class="nav-name">Event <span style="color:var(--p)">Medium</span></span>
    </a>
    <a href="/events.html" class="nav-back"><i data-lucide="arrow-left" style="width:16px;height:16px"></i> All Events</a>
  </div>
</nav>

<div class="page" id="page"><div class="loading">Loading event...</div></div>
<div class="toast" id="toast"></div>

<!-- Calendar Modal (shared component) -->
<script src="/js/calendar-modal.js"></script>

<script>
var token = localStorage.getItem('auth_token');
var eventId = new URLSearchParams(window.location.search).get('id');
var isRegistered = false;
var currentEvent = null;

async function loadEvent() {
  if (!eventId) { window.location.href = '/events.html'; return; }
  document.getElementById('page').innerHTML = '<div style="text-align:center;padding:120px 24px;color:var(--txtL)"><div style="margin-bottom:8px"><i data-lucide="loader" style="width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block"></i></div>Loading event...</div>';
  try {
    var resp = await fetch('/api/events/' + eventId);
    if (!resp.ok) throw new Error();
    var data = await resp.json();
    var e = data.event;
    if (!e) throw new Error();
    currentEvent = e;

    if (token) {
      try {
        var regResp = await fetch('/api/events/user/registrations', { headers: { 'Authorization': 'Bearer ' + token } });
        var regData = await regResp.json();
        isRegistered = (regData.registrations || regData.events || []).some(function(r) { return r.id == eventId; });
      } catch(x) {}
    }

    document.title = e.name + ' — Event Medium';
    var date = e.event_date ? new Date(e.event_date) : null;
    var dateStr = date ? date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : 'TBD';
    var isPast = date && date < new Date();
    var themes = parseArr(e.themes);
    var appUrl = 'https://www.eventmedium.ai';

    // Share text (updated messaging)
    var shareUrl = appUrl + '/event.html?id=' + e.id;
    var shareText = 'At ' + e.name + ' this week. Should we be talking? See if Nev connects us.';

    // Hero
    var html = '<div class="event-hero">' +
      '<h1>' + esc(e.name) + '</h1>' +
      '<div class="event-meta">' +
        '<span class="meta-item"><i data-lucide="calendar"></i> ' + dateStr + '</span>' +
        (e.city ? '<span class="meta-item"><i data-lucide="map-pin"></i> ' + esc(e.city) + (e.country ? ', ' + esc(e.country) : '') + '</span>' : '') +
        (e.venue ? '<span class="meta-item"><i data-lucide="building"></i> ' + esc(e.venue) + '</span>' : '') +
      '</div>' +
      (themes.length ? '<div class="event-themes">' + themes.map(function(t) { return '<span class="theme-tag">' + esc(t) + '</span>'; }).join('') + '</div>' : '') +
      (e.description ? '<p class="event-desc">' + esc(e.description) + '</p>' : '') +
      '<div class="event-actions">' +
        (token && !isPast ? '<button class="btn-primary ' + (isRegistered ? 'registered' : '') + '" id="regBtn" onclick="toggleRegister()"><i data-lucide="' + (isRegistered ? 'check' : 'users') + '"></i> ' + (isRegistered ? "I'm Going \u2713" : 'Find My People') + '</button>' : '') +
        (!token && !isPast ? '<a href="/auth.html" class="btn-primary"><i data-lucide="users"></i> Sign in to find your people</a>' : '') +
        (e.website_url ? '<a href="' + esc(e.website_url) + '" target="_blank" class="btn-secondary"><i data-lucide="external-link"></i> Event website</a>' : '') +
        (isRegistered ? '<button class="btn-secondary" onclick="openCalendarModal()"><i data-lucide="calendar-plus"></i> Add to calendar</button>' : '') +
        '<button class="btn-secondary btn-sidecar-detail" id="sidecar-detail-btn" style="display:none" onclick="openSidecars(' + e.id + ')"><i data-lucide="layers"></i> <span id="sidecar-detail-label">Sidecar Events</span></button>' +
        '<span class="attendee-count"><i data-lucide="bar-chart-2"></i> Event insights reveal @ 100+</span>' +
      '</div>' +
    '</div>';

    // Countdown
    if (date && !isPast) {
      var now = new Date();
      var diff = date - now;
      var days = Math.floor(diff / (1000 * 60 * 60 * 24));
      var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      var mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      var secs = Math.floor((diff % (1000 * 60)) / 1000);
      html += '<div class="countdown" id="countdown">' +
        '<div class="countdown-label">Event starts in</div>' +
        '<div class="countdown-grid">' +
          '<div class="countdown-unit"><div class="countdown-num" id="cd-days">' + days + '</div><div class="countdown-txt">Days</div></div>' +
          '<div class="countdown-unit"><div class="countdown-num" id="cd-hours">' + hours + '</div><div class="countdown-txt">Hours</div></div>' +
          '<div class="countdown-unit"><div class="countdown-num" id="cd-mins">' + mins + '</div><div class="countdown-txt">Minutes</div></div>' +
          '<div class="countdown-unit"><div class="countdown-num" id="cd-secs">' + secs + '</div><div class="countdown-txt">Seconds</div></div>' +
        '</div>' +
      '</div>';
    }

    // Nev CTA (if attending)
    if (isRegistered && !isPast) {
      html += '<div class="nev-cta">' +
        '<div class="nev-cta-avatar"><i data-lucide="bot" style="width:24px;height:24px;color:white"></i></div>' +
        '<div>' +
          '<h3>Tell Nev what you\'re looking for</h3>' +
          '<p>Get matched with the right people before you arrive at ' + esc(e.name) + '.</p>' +
          '<a href="/onboard.html?event_id=' + e.id + '"><i data-lucide="message-circle" style="width:14px;height:14px"></i> Talk to Nev</a>' +
        '</div>' +
      '</div>';
    }

    // Attendee breakdown
    if ((e.registrations || 0) > 0) {
      html += '<div class="card"><h2>Who\'s attending</h2><div id="attendeeBreakdown"><p style="font-size:13px;color:var(--txtL)">Attendee breakdown available after 10+ registrations.</p></div></div>';
    }

    // Share (always visible, updated messaging)
    html += '<div class="card"><h2>Share this event</h2>' +
      '<p style="font-size:13px;color:var(--txtL);margin-bottom:14px">' + (isRegistered ? 'Let your network know you\'re there. Nev does the rest.' : '') + '</p>' +
      '<div class="share-row">' +
        '<button class="share-btn" onclick="copyShareLink()"><i data-lucide="link"></i> Copy link</button>' +
        '<a href="https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareText) + '&url=' + encodeURIComponent(shareUrl) + '" target="_blank" class="share-btn"><i data-lucide="share-2"></i> X / Twitter</a>' +
        '<a href="https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(shareUrl) + '" target="_blank" class="share-btn"><i data-lucide="share-2"></i> LinkedIn</a>' +
        '<a href="https://wa.me/?text=' + encodeURIComponent(shareText + '\n' + shareUrl) + '" target="_blank" class="share-btn"><i data-lucide="share-2"></i> WhatsApp</a>' +
        '<a href="mailto:?subject=' + encodeURIComponent(e.name + ' \u2014 Event Medium') + '&body=' + encodeURIComponent(shareText + '\n\n' + shareUrl) + '" class="share-btn"><i data-lucide="mail"></i> Email</a>' +
      '</div>' +
    '</div>';

    document.getElementById('page').innerHTML = html;
    lucide.createIcons();
    loadSidecarCount(e.id);

    // Live countdown tick
    if (date && !isPast) {
      setInterval(function() {
        var now = new Date();
        var diff = date - now;
        if (diff <= 0) { document.getElementById('countdown').innerHTML = '<div class="countdown-label">Event is live!</div>'; return; }
        document.getElementById('cd-days').textContent = Math.floor(diff / 86400000);
        document.getElementById('cd-hours').textContent = Math.floor((diff % 86400000) / 3600000);
        document.getElementById('cd-mins').textContent = Math.floor((diff % 3600000) / 60000);
        document.getElementById('cd-secs').textContent = Math.floor((diff % 60000) / 1000);
      }, 1000);
    }

    // Load attendee breakdown if enough registrations
    if ((e.registrations || 0) >= 3 && token) {
      loadAttendeeBreakdown();
    }
  } catch(err) {
    document.getElementById('page').innerHTML = '<div class="loading">Event not found. <a href="/events.html" style="color:var(--p)">Browse events</a></div>';
  }
}

async function loadAttendeeBreakdown() {
  try {
    var resp = await fetch('/api/events/' + eventId + '/demand-signals', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!resp.ok) return;
    var data = await resp.json();
    var types = data.stakeholder_breakdown || [];
    if (!types.length) return;

    var total = types.reduce(function(s, t) { return s + parseInt(t.count); }, 0);
    var html = types.map(function(t) {
      var pct = Math.round((parseInt(t.count) / total) * 100);
      var type = (t.stakeholder_type || 'other').toLowerCase();
      return '<div class="type-bar">' +
        '<div class="type-bar-header"><span class="type-bar-label">' + capitalize(type) + '</span><span class="type-bar-count">' + t.count + ' (' + pct + '%)</span></div>' +
        '<div class="type-bar-track"><div class="type-bar-fill ' + type + '" style="width:' + pct + '%"></div></div>' +
      '</div>';
    }).join('');
    document.getElementById('attendeeBreakdown').innerHTML = html;
  } catch(e) {}
}

async function toggleRegister() {
  if (!token) { window.location.href = '/auth.html'; return; }
  try {
    var resp = await fetch('/api/events/' + eventId + '/register', {
      method: isRegistered ? 'DELETE' : 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (resp.ok) {
      isRegistered = !isRegistered;
      if (isRegistered && currentEvent && window.CalendarModal) {
        // Commit moment — open calendar modal
        CalendarModal.open(currentEvent);
      } else if (!isRegistered) {
        showToast('Removed from event', '');
      }
      loadEvent();
    }
  } catch(e) { showToast('Failed. Try again.', ''); }
}

function openCalendarModal() {
  if (currentEvent && window.CalendarModal) {
    CalendarModal.open(currentEvent);
  }
}

function copyShareLink() {
  var url = 'https://www.eventmedium.ai/event.html?id=' + eventId;
  var msg = currentEvent ? 'At ' + currentEvent.name + ' this week. Should we be talking? See if Nev connects us. ' + url : url;
  navigator.clipboard.writeText(msg);
  showToast('Link copied!', 'success');
}

function parseArr(v) { if (!v) return []; if (Array.isArray(v)) return v; try { return JSON.parse(v); } catch(e) { return []; } }
function esc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }
function showToast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(function() { el.className = 'toast'; }, 3000);
}

lucide.createIcons();
loadEvent();
</script>

<!-- ── SIDECAR EVENTS PANEL ── -->
<div id="sidecar-panel" class="sidecar-panel">
  <div class="sidecar-panel-backdrop" onclick="closeSidecars()"></div>
  <div class="sidecar-panel-content">
    <div class="sidecar-header">
      <div>
        <div class="sidecar-label">SIDECAR EVENTS</div>
        <h2 id="sidecar-parent-name"></h2>
      </div>
      <button class="sidecar-close" onclick="closeSidecars()"><i data-lucide="x" style="width:20px;height:20px"></i></button>
    </div>
    <div class="sidecar-stats" id="sidecar-stats"></div>
    <div class="sidecar-filters" id="sidecar-filters"></div>
    <div class="sidecar-body" id="sidecar-body">
      <div class="sidecar-loading">Loading sidecar events...</div>
    </div>
  </div>
</div>

<style>
.btn-sidecar-detail{position:relative}
.sidecar-count-badge{min-width:20px;height:20px;border-radius:10px;background:#6366f1;color:#fff;font-size:11px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;padding:0 6px;margin-left:4px}
.sidecar-panel{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000}
.sidecar-panel.open{display:flex}
.sidecar-panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.4);animation:sidecarFade .2s ease}
.sidecar-panel-content{position:absolute;right:0;top:0;bottom:0;width:min(520px,90vw);background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,0.15);display:flex;flex-direction:column;animation:sidecarSlide .25s ease;overflow:hidden}
@keyframes sidecarFade{from{opacity:0}to{opacity:1}}
@keyframes sidecarSlide{from{transform:translateX(100%)}to{transform:translateX(0)}}
.sidecar-header{display:flex;justify-content:space-between;align-items:flex-start;padding:20px 24px 16px;border-bottom:1px solid #eee}
.sidecar-label{font-size:11px;font-weight:600;letter-spacing:1.5px;color:#6366f1;margin-bottom:4px}
.sidecar-header h2{margin:0;font-size:18px;font-weight:600;color:#1a1a2e}
.sidecar-close{background:none;border:none;cursor:pointer;padding:4px;color:#888;border-radius:6px}
.sidecar-close:hover{background:#f0f0f0;color:#333}
.sidecar-stats{display:flex;gap:16px;padding:12px 24px;background:#fafafa;border-bottom:1px solid #eee;font-size:13px;color:#666}
.sidecar-stat strong{color:#1a1a2e;font-weight:600}
.sidecar-filters{display:flex;flex-wrap:wrap;gap:6px;padding:12px 24px;border-bottom:1px solid #eee}
.sidecar-chip{padding:4px 12px;border-radius:14px;border:1px solid #e0e0e0;background:#fff;font-size:12px;color:#555;cursor:pointer;transition:all .15s}
.sidecar-chip:hover,.sidecar-chip.active{background:#6366f1;color:#fff;border-color:#6366f1}
.sidecar-body{flex:1;overflow-y:auto}
.sidecar-loading{text-align:center;padding:40px;color:#999;font-size:14px}
.sidecar-day-header{position:sticky;top:0;background:#f7f7f8;padding:10px 24px;font-size:13px;font-weight:600;color:#1a1a2e;border-bottom:1px solid #eee;z-index:1}
.sidecar-day-count{float:right;color:#999;font-weight:400}
.sidecar-event{padding:14px 24px;border-bottom:1px solid #f0f0f0;transition:background .15s}
.sidecar-event:hover{background:#fafafa}
.sidecar-event-time{font-size:12px;color:#6366f1;font-weight:600;margin-bottom:2px}
.sidecar-event-name{font-size:14px;font-weight:600;color:#1a1a2e;margin-bottom:2px}
.sidecar-event-name a{color:inherit;text-decoration:none}
.sidecar-event-name a:hover{text-decoration:underline}
.sidecar-event-org{font-size:12px;color:#888;margin-bottom:6px}
.sidecar-event-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:11px;align-items:center}
.sidecar-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:10px;background:#f0f0f0;color:#666}
.sidecar-badge.free{background:#dcfce7;color:#166534}
.sidecar-badge.paid{background:#fef3c7;color:#92400e}
.sidecar-badge.invite{background:#fce7f3;color:#9d174d}
.sidecar-ticket{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:10px;background:#6366f1;color:#fff;font-size:11px;font-weight:600;text-decoration:none;transition:all .15s;margin-left:auto}
.sidecar-ticket:hover{background:#4f46e5}
@media(max-width:600px){.sidecar-panel-content{width:100vw}}
</style>

<script>
var sidecarData = null;
var sidecarFilter = null;

async function loadSidecarCount(evId) {
  try {
    var resp = await fetch('/api/events/' + evId + '/sidecar-count');
    var data = await resp.json();
    if (data.count > 0) {
      var btn = document.getElementById('sidecar-detail-btn');
      var label = document.getElementById('sidecar-detail-label');
      if (btn) {
        btn.style.display = 'inline-flex';
        label.innerHTML = 'Sidecar Events <span class="sidecar-count-badge">' + data.count + '</span>';
        lucide.createIcons();
      }
    }
  } catch(e) {}
}

async function openSidecars(evId) {
  var panel = document.getElementById('sidecar-panel');
  document.getElementById('sidecar-body').innerHTML = '<div class="sidecar-loading">Loading sidecar events...</div>';
  panel.classList.add('open');
  document.body.style.overflow = 'hidden';
  try {
    var resp = await fetch('/api/events/' + evId + '/sidecars');
    sidecarData = await resp.json();
    sidecarFilter = null;
    document.getElementById('sidecar-parent-name').textContent = sidecarData.parent.name;
    var s = sidecarData.stats;
    document.getElementById('sidecar-stats').innerHTML =
      '<span class="sidecar-stat"><strong>' + s.total + '</strong> events</span>' +
      '<span class="sidecar-stat"><strong>' + s.days + '</strong> days</span>' +
      '<span class="sidecar-stat"><strong>' + s.free + '</strong> free</span>' +
      (s.invite_only > 0 ? '<span class="sidecar-stat"><strong>' + s.invite_only + '</strong> invite-only</span>' : '');
    buildSidecarChips(sidecarData.sidecars);
    renderSidecarList(sidecarData.sidecars);
    lucide.createIcons();
  } catch(e) {
    document.getElementById('sidecar-body').innerHTML = '<div class="sidecar-loading">Failed to load sidecar events.</div>';
  }
}

function closeSidecars() {
  document.getElementById('sidecar-panel').classList.remove('open');
  document.body.style.overflow = '';
}

function buildSidecarChips(sidecars) {
  var counts = {};
  var filterTags = ['Conference','Networking','Party','Hackathon','Brunch','Wellness','VCs/Angels','Devs/Builders','DeFi','AI','RWA'];
  sidecars.forEach(function(s) {
    var tags = Array.isArray(s.tags) ? s.tags : JSON.parse(s.tags || '[]');
    tags.forEach(function(t) { if (filterTags.indexOf(t) !== -1) counts[t] = (counts[t] || 0) + 1; });
  });
  var sorted = Object.keys(counts).sort(function(a,b) { return counts[b] - counts[a]; }).slice(0, 8);
  var h = '<span class="sidecar-chip active" onclick="filterSidecarList(null)">All</span>';
  sorted.forEach(function(t) { h += '<span class="sidecar-chip" onclick="filterSidecarList(\'' + t + '\')">' + t + '</span>'; });
  document.getElementById('sidecar-filters').innerHTML = h;
}

function filterSidecarList(tag) {
  sidecarFilter = tag;
  document.querySelectorAll('.sidecar-chip').forEach(function(c) {
    c.classList.remove('active');
    if ((!tag && c.textContent === 'All') || c.textContent === tag) c.classList.add('active');
  });
  var filtered = sidecarData.sidecars;
  if (tag) filtered = filtered.filter(function(s) {
    var tags = Array.isArray(s.tags) ? s.tags : JSON.parse(s.tags || '[]');
    return tags.indexOf(tag) !== -1;
  });
  renderSidecarList(filtered);
}

function renderSidecarList(sidecars) {
  var body = document.getElementById('sidecar-body');
  if (!sidecars.length) { body.innerHTML = '<div class="sidecar-loading">No events match this filter.</div>'; return; }
  var days = {};
  sidecars.forEach(function(s) { var d = (s.event_date || '').split('T')[0]; if (!days[d]) days[d] = []; days[d].push(s); });
  var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var h = '';
  Object.keys(days).sort().forEach(function(dateStr) {
    var evts = days[dateStr];
    var d = new Date(dateStr + 'T12:00:00');
    var label = dayNames[d.getDay()] + ', ' + monthNames[d.getMonth()] + ' ' + d.getDate();
    h += '<div class="sidecar-day-header">' + label + '<span class="sidecar-day-count">' + evts.length + ' event' + (evts.length !== 1 ? 's' : '') + '</span></div>';
    evts.forEach(function(ev) {
      var st = ev.start_time ? fmtSidecarTime(ev.start_time) : '';
      var et = ev.end_time ? fmtSidecarTime(ev.end_time) : '';
      var time = st + (et ? ' \u2013 ' + et : '');
      var cost = ev.cost === 'Free' ? '<span class="sidecar-badge free">Free</span>' : (ev.cost && ev.cost !== 'TBA' ? '<span class="sidecar-badge paid">' + ev.cost + '</span>' : '');
      var inv = ev.invite_only ? '<span class="sidecar-badge invite">Invite Only</span>' : '';
      var ven = ev.venue_name ? '<span class="sidecar-badge">' + ev.venue_name + '</span>' : '';
      var ticket = ev.source_url ? '<a href="' + ev.source_url + '" target="_blank" class="sidecar-ticket" onclick="event.stopPropagation()"><i data-lucide="ticket" style="width:12px;height:12px"></i> Get Tickets</a>' : '';
      h += '<div class="sidecar-event">' +
        (time ? '<div class="sidecar-event-time">' + time + '</div>' : '') +
        '<div class="sidecar-event-name">' + (ev.source_url ? '<a href="' + ev.source_url + '" target="_blank">' + ev.name + '</a>' : ev.name) + '</div>' +
        (ev.organizer ? '<div class="sidecar-event-org">by ' + ev.organizer + '</div>' : '') +
        '<div class="sidecar-event-meta">' + cost + inv + ven + ticket + '</div></div>';
    });
  });
  body.innerHTML = h;
  lucide.createIcons();
}

function fmtSidecarTime(t) { if (!t) return ''; var p = t.split(':'); var h = parseInt(p[0]); var m = p[1] || '00'; var s = h >= 12 ? 'p' : 'a'; if (h > 12) h -= 12; if (h === 0) h = 12; return h + (m !== '00' ? ':' + m : '') + s; }

document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeSidecars(); });
</script>

<script src="/js/nav.js"></script></body>
</html>