<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Browse Events — Event Medium</title>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root {
  --p: #0066ff;--pL: #e8f0fe;--pD: #0052cc;--s: #6c63ff;--ok: #00d084;
  --okL: #e6faf2;--warn: #f59e0b;--bg: #f8f9fd;--card: #ffffff;
  --txt: #1a1d29;--txtL: #6b7280;--txtXL: #9ca3af;--bdr: #e5e7eb;
  --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadowL: 0 10px 25px rgba(0,0,0,0.08);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);color:var(--txt);background:var(--bg);-webkit-font-smoothing:antialiased}

/* Nav */
.nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(255,255,255,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--bdr);padding:0 24px}
.nav-inner{max-width:1140px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px}
.nav-brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--txt)}
.nav-logo{width:36px;height:36px;background:var(--p);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white}
.nav-name{font-weight:800;font-size:1.15rem;letter-spacing:-0.3px}
.nav-links{display:flex;align-items:center;gap:8px}
.nav-link{padding:8px 16px;color:var(--txtL);text-decoration:none;font-size:14px;font-weight:500;border-radius:8px;transition:all 0.2s}
.nav-link:hover{color:var(--txt);background:var(--card)}
.nav-link.active{color:var(--p);font-weight:600}
.nav-cta{padding:8px 20px;background:var(--p);color:white;font-size:14px;font-weight:600;border-radius:8px;text-decoration:none;transition:all 0.2s}
.nav-cta:hover{background:var(--pD)}

/* Page */
.page{max-width:1140px;margin:0 auto;padding:88px 24px 60px}
.page-header{margin-bottom:32px}
.page-header h1{font-size:28px;font-weight:700;margin-bottom:8px}
.page-header p{font-size:15px;color:var(--txtL)}

/* Filters */
.filters{display:flex;gap:10px;margin-bottom:28px;flex-wrap:wrap;align-items:center}
.filter-input{padding:10px 14px;border:1px solid var(--bdr);border-radius:10px;font-size:14px;font-family:var(--font);background:var(--card);color:var(--txt);min-width:220px;transition:border 0.2s}
.filter-input:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 3px var(--pL)}
.filter-select{padding:10px 14px;border:1px solid var(--bdr);border-radius:10px;font-size:14px;font-family:var(--font);background:var(--card);color:var(--txt);cursor:pointer}
.filter-select:focus{outline:none;border-color:var(--p)}
.filter-check{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--txtL);cursor:pointer;user-select:none}
.filter-check input{accent-color:var(--p)}
.filter-spacer{flex:1}
.filter-btn{padding:10px 20px;background:var(--card);color:var(--txt);border:1px solid var(--bdr);border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--font);transition:all 0.2s;display:flex;align-items:center;gap:6px}
.filter-btn:hover{border-color:var(--p);color:var(--p);background:var(--pL)}
.filter-btn i{width:14px;height:14px}
.sort-select{padding:10px 14px;border:1px solid var(--bdr);border-radius:10px;font-size:13px;font-family:var(--font);background:var(--card);color:var(--txtL);cursor:pointer}

/* Events grid */
.events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px}
.event-card{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px;transition:all 0.3s;cursor:pointer;display:flex;flex-direction:column}
.event-card:hover{border-color:var(--p);box-shadow:var(--shadowL);transform:translateY(-2px)}
.event-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:12px}
.event-card h3{font-size:17px;font-weight:700;line-height:1.3;flex:1}
.event-date-badge{background:var(--pL);color:var(--p);padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600;white-space:nowrap;flex-shrink:0}
.event-date-badge.past{background:#fef2f2;color:#ef4444}
.event-meta{display:flex;gap:16px;margin-bottom:12px;flex-wrap:wrap}
.event-meta-item{display:flex;align-items:center;gap:5px;font-size:13px;color:var(--txtL)}
.event-meta-item i{width:14px;height:14px}
.event-desc{font-size:13px;color:var(--txtL);line-height:1.6;margin-bottom:14px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.event-themes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.event-theme{padding:3px 10px;background:var(--pL);color:var(--p);font-size:11px;font-weight:600;border-radius:6px}

/* Countdown */
.event-countdown{display:flex;gap:8px;margin-bottom:14px;padding:10px 14px;background:var(--bg);border-radius:10px}
.cd-unit{text-align:center;flex:1}
.cd-num{font-size:18px;font-weight:700;color:var(--p);line-height:1.2}
.cd-label{font-size:10px;color:var(--txtXL);text-transform:uppercase;letter-spacing:0.5px}

/* Footer row */
.event-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto;padding-top:14px;border-top:1px solid var(--bdr)}
.event-attendees{font-size:13px;color:var(--txtL);display:flex;align-items:center;gap:5px}
.event-attendees i{width:14px;height:14px}
.event-footer-right{display:flex;gap:6px;align-items:center}
.share-icon-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:var(--okL);color:#059669;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s}
.share-icon-btn:hover{background:#d1fae5}
.share-icon-btn i{width:14px;height:14px}
.register-btn{padding:8px 18px;background:var(--p);color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:var(--font)}
.register-btn:hover{background:var(--pD)}
.register-btn.registered{background:var(--okL);color:#059669}
.register-btn.registered:hover{background:#d1fae5}

/* Skeleton loading */
.skeleton{animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.skel-card{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px}
.skel-line{height:14px;background:var(--bdr);border-radius:6px;margin-bottom:10px}
.skel-line.w60{width:60%}
.skel-line.w80{width:80%}
.skel-line.w40{width:40%}
.skel-line.h24{height:24px}
.skel-tags{display:flex;gap:6px;margin-top:12px}
.skel-tag{width:60px;height:22px;background:var(--bdr);border-radius:6px}

/* Pagination */
.pagination{display:flex;justify-content:center;gap:8px;margin-top:32px}
.page-btn{padding:8px 16px;border:1px solid var(--bdr);border-radius:8px;background:var(--card);color:var(--txtL);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:var(--font)}
.page-btn:hover{border-color:var(--p);color:var(--p)}
.page-btn.active{background:var(--p);color:white;border-color:var(--p)}
.page-btn:disabled{opacity:0.4;cursor:not-allowed}

/* Results info */
.results-info{font-size:13px;color:var(--txtXL);margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}

/* Empty state */
.empty{text-align:center;padding:80px 24px;color:var(--txtL)}
.empty-icon{width:64px;height:64px;border-radius:16px;background:var(--bg);display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.empty-icon i{width:32px;height:32px;color:var(--txtXL)}
.empty h3{font-size:18px;color:var(--txt);margin-bottom:8px}
.empty p{font-size:14px;max-width:400px;margin:0 auto}
.empty a{color:var(--p);font-weight:600;text-decoration:none}

/* Submit modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:200;display:none;align-items:center;justify-content:center;padding:24px}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border-radius:16px;padding:32px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadowL)}
.modal h2{font-size:20px;font-weight:700;margin-bottom:4px}
.modal-sub{font-size:14px;color:var(--txtL);margin-bottom:24px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--txt)}
.form-input,.form-textarea,.form-select{width:100%;padding:10px 14px;border:1px solid var(--bdr);border-radius:10px;font-size:14px;font-family:var(--font);background:var(--card);color:var(--txt);transition:border 0.2s}
.form-textarea{resize:vertical;min-height:80px}
.form-input:focus,.form-textarea:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 3px var(--pL)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-hint{font-size:12px;color:var(--txtXL);margin-top:4px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}
.modal-btn{padding:10px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--font);border:none;transition:all 0.2s}
.modal-btn.cancel{background:var(--bg);color:var(--txtL)}
.modal-btn.cancel:hover{background:var(--bdr)}
.modal-btn.primary{background:var(--p);color:white}
.modal-btn.primary:hover{background:var(--pD)}
.modal-btn:disabled{opacity:0.5;cursor:not-allowed}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--txt);color:white;padding:12px 24px;border-radius:10px;font-size:14px;font-weight:500;z-index:300;transition:transform 0.3s ease;box-shadow:var(--shadowL)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{background:#059669}
.toast.error{background:#ef4444}

@media(max-width:768px){
  .nav-links .nav-link{display:none}
  .page{padding:80px 16px 40px}
  .filters{flex-direction:column}
  .filter-input,.filter-select,.sort-select{width:100%}
  .filter-spacer{display:none}
  .events-grid{grid-template-columns:1fr}
  .event-card{padding:20px}
  .event-footer-right{flex-wrap:wrap}
}

.rec-section{margin-bottom:24px;padding:24px;background:linear-gradient(135deg,#f0f4ff 0%,#f8f0ff 100%);border:1px solid #e0e4f0;border-radius:16px}
.rec-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.rec-header h3{font-size:16px;font-weight:700;color:var(--txt)}
.rec-header .rec-badge{font-size:11px;font-weight:700;padding:3px 10px;background:var(--p);color:white;border-radius:12px;letter-spacing:0.5px}
.rec-scroll{display:flex;gap:14px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch}
.rec-scroll::-webkit-scrollbar{height:4px}
.rec-scroll::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:4px}
.rec-card{flex:0 0 280px;background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;position:relative}
.rec-card:hover{border-color:var(--p);box-shadow:var(--shadowL)}
.rec-score{position:absolute;top:12px;right:12px;font-size:18px;font-weight:800;color:var(--p);font-family:-apple-system,sans-serif}
.rec-name{font-size:14px;font-weight:700;margin-bottom:4px;padding-right:40px}
.rec-meta{font-size:12px;color:var(--txtL);margin-bottom:8px}
.rec-reasons{display:flex;flex-wrap:wrap;gap:4px}
.rec-reason{font-size:11px;padding:3px 8px;background:var(--pL);color:var(--p);border-radius:6px;font-weight:500}
</style>
<link rel="stylesheet" href="/css/nav.css"></head>
<body>

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">
      <div class="nav-logo"><i data-lucide="radio" style="width:20px;height:20px;color:var(--p)"></i></div>
      <span class="nav-name">Event <span style="color:var(--p)">Medium</span></span>
    </a>
    <div class="nav-links">
      <a href="/events.html" class="nav-link active">Events</a>
      <a href="/matches.html" class="nav-link" id="nav-matches">Matches</a>
      <a href="/inbox.html" class="nav-link" id="nav-inbox">Inbox</a>
      <a href="/canister.html" class="nav-link" id="nav-canister">My Canister</a>
      <a href="/auth.html" class="nav-cta" id="nav-cta">Sign in</a>
    </div>
  </div>
</nav>

<div class="page">
  <div class="page-header">
    <h1>Browse Events</h1>
    <p>Find your next event and get matched before you arrive.</p>
  </div>

  <div class="filters">
    <input type="text" class="filter-input" id="searchInput" placeholder="Search events...">
    <select class="filter-select" id="themeFilter">
      <option value="">All themes</option>
      <option value="AI">AI</option>
      <option value="Fintech">Fintech</option>
      <option value="Climate">Climate</option>
      <option value="Health">Health</option>
      <option value="Cybersecurity">Cybersecurity</option>
      <option value="Enterprise SaaS">Enterprise SaaS</option>
      <option value="Web3">Web3</option>
      <option value="Quantum">Quantum</option>
      <option value="Space">Space</option>
      <option value="Robotics">Robotics</option>
      <option value="Defence">Defence</option>
      <option value="Education">Education</option>
      <option value="Supply Chain">Supply Chain</option>
      <option value="Real Estate">Real Estate</option>
      <option value="Food & Agriculture">Food & Agriculture</option>
      <option value="Media & Entertainment">Media & Entertainment</option>
    </select>
    <label class="filter-check">
      <input type="checkbox" id="upcomingOnly" checked> Upcoming only
    </label>
    <div class="filter-spacer"></div>
    <select class="sort-select" id="sortSelect">
      <option value="date_asc">Soonest first</option>
      <option value="date_desc">Latest first</option>
      <option value="popular">Most popular</option>
    </select>
    <button class="filter-btn" onclick="openSubmitModal()">
      <i data-lucide="plus"></i> Submit Event
    </button>
  </div>

  <div class="results-info" id="resultsInfo"></div>
  <div id="eventsContainer"></div>
  <div class="pagination" id="pagination"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Submit Event Modal -->
<div class="modal-overlay" id="submitModal">
  <div class="modal">
    <h2>Submit an Event</h2>
    <p class="modal-sub">Add an event to the platform. We'll review and publish it.</p>
    <form id="submitForm">
      <div class="form-group">
        <label class="form-label">Event name *</label>
        <input type="text" class="form-input" id="submitName" required placeholder="e.g. AI Summit London 2026">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="submitDesc" placeholder="What's the event about? Who should attend?"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Date *</label>
        <input type="date" class="form-input" id="submitDate" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">City *</label>
          <input type="text" class="form-input" id="submitCity" required placeholder="London">
        </div>
        <div class="form-group">
          <label class="form-label">Country *</label>
          <input type="text" class="form-input" id="submitCountry" required placeholder="UK">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Venue</label>
        <input type="text" class="form-input" id="submitVenue" placeholder="ExCeL London">
      </div>
      <div class="form-group">
        <label class="form-label">Website</label>
        <input type="url" class="form-input" id="submitUrl" placeholder="https://...">
      </div>
      <div class="form-group">
        <label class="form-label">Themes</label>
        <input type="text" class="form-input" id="submitThemes" placeholder="AI, Health, Robotics">
        <div class="form-hint">Comma separated. These help us match attendees.</div>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn cancel" onclick="closeSubmitModal()">Cancel</button>
        <button type="submit" class="modal-btn primary" id="submitBtn">Submit Event</button>
      </div>
    </form>
  </div>
</div>

<!-- Calendar Modal (shared component) -->
<script src="/js/calendar-modal.js"></script>

<script>
var token = localStorage.getItem('auth_token');
var myRegistrations = [];
var allEvents = [];
var currentPage = 1;
var perPage = 12;


// Show skeleton loading
function showSkeleton() {
  var html = '<div class="events-grid">';
  for (var i = 0; i < 6; i++) {
    html += '<div class="skel-card skeleton">' +
      '<div class="skel-line h24 w80"></div>' +
      '<div class="skel-line w60"></div>' +
      '<div class="skel-line w80"></div>' +
      '<div class="skel-tags"><div class="skel-tag"></div><div class="skel-tag"></div><div class="skel-tag"></div></div>' +
    '</div>';
  }
  html += '</div>';
  document.getElementById('eventsContainer').innerHTML = html;
}

// Load events
async function loadEvents() {
  showSkeleton();
  var search = document.getElementById('searchInput').value;
  var theme = document.getElementById('themeFilter').value;
  var upcoming = document.getElementById('upcomingOnly').checked;

  var params = new URLSearchParams();
  if (search) params.set('search', search);
  if (theme) params.set('theme', theme);
  if (upcoming) params.set('upcoming', 'true');

  try {
    var resp = await fetch('/api/events?' + params.toString());
    var data = await resp.json();
    allEvents = data.events || [];

    // Load user registrations
    if (token) {
      try {
        var regResp = await fetch('/api/events/user/registrations', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        var regData = await regResp.json();
        myRegistrations = (regData.registrations || regData.events || []).map(function(r) { return r.id; });
      } catch(e) {}
    }

    // Sort
    sortEvents();
    currentPage = 1;
    renderEvents();
    if (token && typeof loadRecommended === "function") loadRecommended();
  } catch (err) {
    document.getElementById('eventsContainer').innerHTML =
      '<div class="empty"><div class="empty-icon"><i data-lucide="wifi-off"></i></div><h3>Failed to load events</h3><p>Check your connection and try again.</p></div>';
    lucide.createIcons();
  }
}

function sortEvents() {
  var sort = document.getElementById('sortSelect').value;
  allEvents.sort(function(a, b) {
    if (sort === 'popular') return (b.registrations || 0) - (a.registrations || 0);
    var da = a.event_date ? new Date(a.event_date).getTime() : 0;
    var db = b.event_date ? new Date(b.event_date).getTime() : 0;
    return sort === 'date_desc' ? db - da : da - db;
  });
}

function getEventById(id) {
  return allEvents.find(function(e) { return e.id === id; });
}

function renderEvents() {
  var container = document.getElementById('eventsContainer');
  var totalPages = Math.ceil(allEvents.length / perPage);
  var start = (currentPage - 1) * perPage;
  var pageEvents = allEvents.slice(start, start + perPage);

  // Results info
  document.getElementById('resultsInfo').innerHTML = allEvents.length
    ? allEvents.length + ' event' + (allEvents.length !== 1 ? 's' : '') + ' found'
    : '';

  if (!pageEvents.length) {
    container.innerHTML = '<div class="empty"><div class="empty-icon"><i data-lucide="calendar-x"></i></div>' +
      '<h3>No events found</h3><p>Try adjusting your filters or <a href="#" onclick="openSubmitModal();return false">submit a new event</a>.</p></div>';
    document.getElementById('pagination').innerHTML = '';
    lucide.createIcons();
    return;
  }

  container.innerHTML = '<div class="events-grid">' + pageEvents.map(function(e) {
    var date = e.event_date ? new Date(e.event_date) : null;
    var isPast = date && date < new Date();
    var dateStr = date ? date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'TBD';
    var themes = parseArr(e.themes);
    var isRegistered = myRegistrations.indexOf(e.id) !== -1;

    return '<div class="event-card" onclick="goToEvent(' + e.id + ')">' +
      '<div class="event-card-header">' +
        '<h3>' + esc(e.name) + '</h3>' +
        '<span class="event-date-badge ' + (isPast ? 'past' : '') + '">' + dateStr + '</span>' +
      '</div>' +
      '<div class="event-meta">' +
        (e.city ? '<span class="event-meta-item"><i data-lucide="map-pin"></i>' + esc(e.city) + (e.country ? ', ' + esc(e.country) : '') + '</span>' : '') +
        (e.venue ? '<span class="event-meta-item"><i data-lucide="building"></i>' + esc(e.venue) + '</span>' : '') +
      '</div>' +
      (e.description ? '<p class="event-desc">' + esc(e.description) + '</p>' : '') +
      (themes.length ? '<div class="event-themes">' + themes.slice(0, 4).map(function(t) { return '<span class="event-theme">' + esc(t) + '</span>'; }).join('') + (themes.length > 4 ? '<span class="event-theme" style="background:var(--bg);color:var(--txtXL)">+' + (themes.length - 4) + '</span>' : '') + '</div>' : '') +
      (!isPast && date ? buildCountdown(date) : '') +
      '<div class="event-footer">' +
        '<span class="event-attendees"><i data-lucide="bar-chart-2"></i> Event insights reveal @ 100+</span>' +
        '<div class="event-footer-right">' +
          '<button class="share-icon-btn btn-sidecar-card" onclick="event.stopPropagation();openSidecars(' + e.id + ')" title="Sidecar Events" style="display:none" id="sidecar-btn-' + e.id + '"><i data-lucide="layers"></i><span class="sidecar-badge-count" id="sidecar-count-' + e.id + '"></span></button>' +
          (isRegistered ? '<button class="share-icon-btn" style="background:var(--pL);color:var(--p)" onclick="event.stopPropagation();openShareForEvent(' + e.id + ')" title="Add to Calendar"><i data-lucide="calendar-plus"></i></button>' : '') +
          (token && !isPast ? '<button class="register-btn ' + (isRegistered ? 'registered' : '') + '" onclick="event.stopPropagation();toggleRegister(' + e.id + ',this)">' + (isRegistered ? "I\'m Going \u2713" : 'Find My People') + '</button>' : '') +
          (!token && !isPast ? '<a href="/auth.html" class="register-btn" onclick="event.stopPropagation()" style="text-decoration:none;display:inline-block">Find My People</a>' : '') +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('') + '</div>';

  // Pagination
  if (totalPages > 1) {
    var pag = '<button class="page-btn" onclick="goPage(' + (currentPage - 1) + ')" ' + (currentPage <= 1 ? 'disabled' : '') + '>&laquo;</button>';
    for (var p = 1; p <= totalPages; p++) {
      if (totalPages > 7 && Math.abs(p - currentPage) > 2 && p !== 1 && p !== totalPages) {
        if (p === 2 || p === totalPages - 1) pag += '<span style="padding:8px 4px;color:var(--txtXL)">...</span>';
        continue;
      }
      pag += '<button class="page-btn ' + (p === currentPage ? 'active' : '') + '" onclick="goPage(' + p + ')">' + p + '</button>';
    }
    pag += '<button class="page-btn" onclick="goPage(' + (currentPage + 1) + ')" ' + (currentPage >= totalPages ? 'disabled' : '') + '>&raquo;</button>';
    document.getElementById('pagination').innerHTML = pag;
  } else {
    document.getElementById('pagination').innerHTML = '';
  }

  lucide.createIcons();
  loadSidecarCounts();
}

function goPage(p) {
  var totalPages = Math.ceil(allEvents.length / perPage);
  if (p < 1 || p > totalPages) return;
  currentPage = p;
  renderEvents();
  window.scrollTo({ top: 200, behavior: 'smooth' });
}

function goToEvent(id) { window.location.href = '/event.html?id=' + id; }

function openShareForEvent(eventId) {
  var ev = getEventById(eventId);
  if (ev && window.CalendarModal) CalendarModal.open(ev);
}

async function toggleRegister(eventId, btn) {
  if (!token) { window.location.href = '/auth.html'; return; }
  var isRegistered = myRegistrations.indexOf(eventId) !== -1;
  try {
    var resp = await fetch('/api/events/' + eventId + '/register', {
      method: isRegistered ? 'DELETE' : 'POST',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (resp.ok) {
      if (isRegistered) {
        // Removing attendance
        myRegistrations = myRegistrations.filter(function(id) { return id !== eventId; });
        btn.className = 'register-btn';
        btn.textContent = 'Find My People';
        showToast('Removed from event', '');
        // Re-render to remove share icon
        renderEvents();
      } else {
        // Confirming attendance — open calendar modal
        myRegistrations.push(eventId);
        btn.className = 'register-btn registered';
        btn.textContent = "I'm Going \u2713";
        var ev = getEventById(eventId);
        if (ev && window.CalendarModal) {
          CalendarModal.open(ev);
        } else {
          showToast("You're going! Nev will find your matches.", 'success');
        }
        // Re-render to add share icon
        renderEvents();
      }
    }
  } catch(e) { showToast('Failed. Try again.', 'error'); }
}

// Helpers
function buildCountdown(date) {
  var now = new Date();
  var diff = date - now;
  if (diff <= 0) return '';
  var days = Math.floor(diff / (1000 * 60 * 60 * 24));
  var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  var mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  return '<div class="event-countdown">' +
    '<div class="cd-unit"><div class="cd-num">' + days + '</div><div class="cd-label">days</div></div>' +
    '<div class="cd-unit"><div class="cd-num">' + hours + '</div><div class="cd-label">hrs</div></div>' +
    '<div class="cd-unit"><div class="cd-num">' + mins + '</div><div class="cd-label">min</div></div>' +
  '</div>';
}

function parseArr(v) { if (!v) return []; if (Array.isArray(v)) return v; try { return JSON.parse(v); } catch(e) { return []; } }
function esc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function showToast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(function() { el.className = 'toast'; }, 3000);
}

// Submit modal
function openSubmitModal() {
  if (!token) { window.location.href = '/auth.html'; return; }
  document.getElementById('submitModal').classList.add('active');
}
function closeSubmitModal() { document.getElementById('submitModal').classList.remove('active'); }
document.getElementById('submitModal').addEventListener('click', function(e) { if (e.target === this) closeSubmitModal(); });

document.getElementById('submitForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  var btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = 'Submitting...';
  var themes = document.getElementById('submitThemes').value.split(',').map(function(t) { return t.trim(); }).filter(Boolean);
  try {
    var resp = await fetch('/api/events/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({
        name: document.getElementById('submitName').value,
        description: document.getElementById('submitDesc').value,
        event_date: document.getElementById('submitDate').value,
        city: document.getElementById('submitCity').value,
        country: document.getElementById('submitCountry').value,
        venue: document.getElementById('submitVenue').value,
        website_url: document.getElementById('submitUrl').value,
        themes: themes
      })
    });
    if (resp.ok) {
      closeSubmitModal();
      document.getElementById('submitForm').reset();
      showToast('Event submitted!', 'success');
      loadEvents();
    } else {
      var data = await resp.json();
      showToast(data.error || 'Submission failed', 'error');
    }
  } catch(e) { showToast('Connection error', 'error'); }
  btn.disabled = false; btn.textContent = 'Submit Event';
});

// Filters
var searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(loadEvents, 300);
});
async function loadRecommended() {
  try {
    var resp = await fetch('/api/events/recommended', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    var data = await resp.json();
    if (!data.recommendations || !data.recommendations.length) return;
    var recs = data.recommendations;
    var container = document.getElementById('recSection');
    if (!container) {
      container = document.createElement('div');
      container.id = 'recSection';
      var evContainer = document.getElementById('eventsContainer');
      evContainer.parentNode.insertBefore(container, evContainer);
    }
    container.innerHTML = '<div class="rec-section">' +
      '<div class="rec-header"><i data-lucide="sparkles" style="width:18px;height:18px;color:var(--p)"></i><h3>Recommended for You</h3><span class="rec-badge">BASED ON YOUR CANISTER</span></div>' +
      '<div class="rec-scroll">' +
      recs.map(function(r) {
        var date = r.event_date ? new Date(r.event_date).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : 'TBD';
        return '<div class="rec-card" onclick="goToEvent(' + r.id + ')">' +
          '<div class="rec-score">' + r.score + '%</div>' +
          '<div class="rec-name">' + esc(r.name) + '</div>' +
          '<div class="rec-meta">' + date + (r.city ? ' · ' + esc(r.city) : '') + '</div>' +
          '<div class="rec-reasons">' + (r.reasons || []).map(function(reason) {
            return '<span class="rec-reason">' + esc(reason) + '</span>';
          }).join('') + '</div>' +
        '</div>';
      }).join('') +
      '</div></div>';
    lucide.createIcons();
  } catch(e) { console.log('Recommendations not available'); }
}

document.getElementById('themeFilter').addEventListener('change', loadEvents);
document.getElementById('upcomingOnly').addEventListener('change', loadEvents);
document.getElementById('sortSelect').addEventListener('change', function() { sortEvents(); currentPage = 1; renderEvents(); });

// Init
lucide.createIcons();
loadEvents();

// Refresh countdowns daily
setInterval(loadEvents, 24 * 60 * 60 * 1000);
</script>

<!-- ── SIDECAR EVENTS PANEL ── -->
<div id="sidecar-panel" class="sidecar-panel">
  <div class="sidecar-panel-backdrop" onclick="closeSidecars()"></div>
  <div class="sidecar-panel-content">
    <div class="sidecar-header">
      <div>
        <div class="sidecar-label">SIDECAR EVENTS</div>
        <h2 id="sidecar-parent-name"></h2>
      </div>
      <button class="sidecar-close" onclick="closeSidecars()"><i data-lucide="x" style="width:20px;height:20px"></i></button>
    </div>
    <div class="sidecar-stats" id="sidecar-stats"></div>
    <div class="sidecar-filters" id="sidecar-filters"></div>
    <div class="sidecar-body" id="sidecar-body">
      <div class="sidecar-loading">Loading sidecar events...</div>
    </div>
  </div>
</div>

<style>
.btn-sidecar-card{position:relative}
.sidecar-badge-count{position:absolute;top:-6px;right:-6px;min-width:18px;height:18px;border-radius:9px;background:#6366f1;color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 4px}
.sidecar-badge-count:empty{display:none}
.sidecar-panel{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000}
.sidecar-panel.open{display:flex}
.sidecar-panel-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.4);animation:sidecarFade .2s ease}
.sidecar-panel-content{position:absolute;right:0;top:0;bottom:0;width:min(520px,90vw);background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,0.15);display:flex;flex-direction:column;animation:sidecarSlide .25s ease;overflow:hidden}
@keyframes sidecarFade{from{opacity:0}to{opacity:1}}
@keyframes sidecarSlide{from{transform:translateX(100%)}to{transform:translateX(0)}}
.sidecar-header{display:flex;justify-content:space-between;align-items:flex-start;padding:20px 24px 16px;border-bottom:1px solid #eee}
.sidecar-label{font-size:11px;font-weight:600;letter-spacing:1.5px;color:#6366f1;margin-bottom:4px}
.sidecar-header h2{margin:0;font-size:18px;font-weight:600;color:#1a1a2e}
.sidecar-close{background:none;border:none;cursor:pointer;padding:4px;color:#888;border-radius:6px}
.sidecar-close:hover{background:#f0f0f0;color:#333}
.sidecar-stats{display:flex;gap:16px;padding:12px 24px;background:#fafafa;border-bottom:1px solid #eee;font-size:13px;color:#666}
.sidecar-stat strong{color:#1a1a2e;font-weight:600}
.sidecar-filters{display:flex;flex-wrap:wrap;gap:6px;padding:12px 24px;border-bottom:1px solid #eee}
.sidecar-chip{padding:4px 12px;border-radius:14px;border:1px solid #e0e0e0;background:#fff;font-size:12px;color:#555;cursor:pointer;transition:all .15s}
.sidecar-chip:hover,.sidecar-chip.active{background:#6366f1;color:#fff;border-color:#6366f1}
.sidecar-body{flex:1;overflow-y:auto}
.sidecar-loading{text-align:center;padding:40px;color:#999;font-size:14px}
.sidecar-day-header{position:sticky;top:0;background:#f7f7f8;padding:10px 24px;font-size:13px;font-weight:600;color:#1a1a2e;border-bottom:1px solid #eee;z-index:1}
.sidecar-day-count{float:right;color:#999;font-weight:400}
.sidecar-event{padding:14px 24px;border-bottom:1px solid #f0f0f0;transition:background .15s}
.sidecar-event:hover{background:#fafafa}
.sidecar-event-time{font-size:12px;color:#6366f1;font-weight:600;margin-bottom:2px}
.sidecar-event-name{font-size:14px;font-weight:600;color:#1a1a2e;margin-bottom:2px}
.sidecar-event-name a{color:inherit;text-decoration:none}
.sidecar-event-name a:hover{text-decoration:underline}
.sidecar-event-org{font-size:12px;color:#888;margin-bottom:6px}
.sidecar-event-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:11px}
.sidecar-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:10px;background:#f0f0f0;color:#666}
.sidecar-badge.free{background:#dcfce7;color:#166534}
.sidecar-badge.paid{background:#fef3c7;color:#92400e}
.sidecar-badge.invite{background:#fce7f3;color:#9d174d}
.sidecar-ticket{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:10px;background:#6366f1;color:#fff;font-size:11px;font-weight:600;text-decoration:none;transition:all .15s;margin-left:auto}
.sidecar-ticket:hover{background:#4f46e5}
@media(max-width:600px){.sidecar-panel-content{width:100vw}}
</style>

<script>
var sidecarData = null;
var sidecarFilter = null;

async function loadSidecarCounts() {
  var btns = document.querySelectorAll('.btn-sidecar-card');
  for (var i = 0; i < btns.length; i++) {
    var btn = btns[i];
    var id = btn.id.replace('sidecar-btn-', '');
    try {
      var resp = await fetch('/api/events/' + id + '/sidecar-count');
      var data = await resp.json();
      if (data.count > 0) {
        document.getElementById('sidecar-count-' + id).textContent = data.count;
        btn.style.display = 'inline-flex';
      }
    } catch(e) {}
  }
}

async function openSidecars(eventId) {
  var panel = document.getElementById('sidecar-panel');
  document.getElementById('sidecar-body').innerHTML = '<div class="sidecar-loading">Loading sidecar events...</div>';
  panel.classList.add('open');
  document.body.style.overflow = 'hidden';
  try {
    var resp = await fetch('/api/events/' + eventId + '/sidecars');
    sidecarData = await resp.json();
    sidecarFilter = null;
    document.getElementById('sidecar-parent-name').textContent = sidecarData.parent.name;
    var s = sidecarData.stats;
    document.getElementById('sidecar-stats').innerHTML =
      '<span class="sidecar-stat"><strong>' + s.total + '</strong> events</span>' +
      '<span class="sidecar-stat"><strong>' + s.days + '</strong> days</span>' +
      '<span class="sidecar-stat"><strong>' + s.free + '</strong> free</span>' +
      (s.invite_only > 0 ? '<span class="sidecar-stat"><strong>' + s.invite_only + '</strong> invite-only</span>' : '');
    buildFilterChips(sidecarData.sidecars);
    renderSidecars(sidecarData.sidecars);
  } catch(e) {
    document.getElementById('sidecar-body').innerHTML = '<div class="sidecar-loading">Failed to load sidecar events.</div>';
  }
}

function closeSidecars() {
  document.getElementById('sidecar-panel').classList.remove('open');
  document.body.style.overflow = '';
}

function buildFilterChips(sidecars) {
  var counts = {};
  var filterTags = ['Conference','Networking','Party','Hackathon','Brunch','Wellness','VCs/Angels','Devs/Builders','DeFi','AI','RWA'];
  sidecars.forEach(function(s) {
    var tags = Array.isArray(s.tags) ? s.tags : JSON.parse(s.tags || '[]');
    tags.forEach(function(t) { if (filterTags.indexOf(t) !== -1) counts[t] = (counts[t] || 0) + 1; });
  });
  var sorted = Object.keys(counts).sort(function(a,b) { return counts[b] - counts[a]; }).slice(0, 8);
  var html = '<span class="sidecar-chip active" onclick="filterSidecars(null)">All</span>';
  sorted.forEach(function(t) { html += '<span class="sidecar-chip" onclick="filterSidecars(\'' + t + '\')">' + t + '</span>'; });
  document.getElementById('sidecar-filters').innerHTML = html;
}

function filterSidecars(tag) {
  sidecarFilter = tag;
  document.querySelectorAll('.sidecar-chip').forEach(function(c) {
    c.classList.remove('active');
    if ((!tag && c.textContent === 'All') || c.textContent === tag) c.classList.add('active');
  });
  var filtered = sidecarData.sidecars;
  if (tag) filtered = filtered.filter(function(s) {
    var tags = Array.isArray(s.tags) ? s.tags : JSON.parse(s.tags || '[]');
    return tags.indexOf(tag) !== -1;
  });
  renderSidecars(filtered);
}

function renderSidecars(sidecars) {
  var body = document.getElementById('sidecar-body');
  if (!sidecars.length) { body.innerHTML = '<div class="sidecar-loading">No events match this filter.</div>'; return; }
  var days = {};
  sidecars.forEach(function(s) { var d = (s.event_date || '').split('T')[0]; if (!days[d]) days[d] = []; days[d].push(s); });
  var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var html = '';
  Object.keys(days).sort().forEach(function(dateStr) {
    var evts = days[dateStr];
    var d = new Date(dateStr + 'T12:00:00');
    var label = dayNames[d.getDay()] + ', ' + monthNames[d.getMonth()] + ' ' + d.getDate();
    html += '<div class="sidecar-day-header">' + label + '<span class="sidecar-day-count">' + evts.length + ' event' + (evts.length !== 1 ? 's' : '') + '</span></div>';
    evts.forEach(function(ev) {
      var st = ev.start_time ? fmtTime(ev.start_time) : '';
      var et = ev.end_time ? fmtTime(ev.end_time) : '';
      var time = st + (et ? ' \u2013 ' + et : '');
      var cost = ev.cost === 'Free' ? '<span class="sidecar-badge free">Free</span>' : (ev.cost && ev.cost !== 'TBA' ? '<span class="sidecar-badge paid">' + ev.cost + '</span>' : '');
      var inv = ev.invite_only ? '<span class="sidecar-badge invite">Invite Only</span>' : '';
      var ven = ev.venue_name ? '<span class="sidecar-badge">' + ev.venue_name + '</span>' : '';
      var ticket = ev.source_url ? '<a href="' + ev.source_url + '" target="_blank" class="sidecar-ticket" onclick="event.stopPropagation()"><i data-lucide="ticket" style="width:12px;height:12px"></i> Get Tickets</a>' : '';
      html += '<div class="sidecar-event">' +
        (time ? '<div class="sidecar-event-time">' + time + '</div>' : '') +
        '<div class="sidecar-event-name">' + (ev.source_url ? '<a href="' + ev.source_url + '" target="_blank">' + ev.name + '</a>' : ev.name) + '</div>' +
        (ev.organizer ? '<div class="sidecar-event-org">by ' + ev.organizer + '</div>' : '') +
        '<div class="sidecar-event-meta">' + cost + inv + ven + ticket + '</div></div>';
    });
  });
  body.innerHTML = html;
}

function fmtTime(t) { if (!t) return ''; var p = t.split(':'); var h = parseInt(p[0]); var m = p[1] || '00'; var s = h >= 12 ? 'p' : 'a'; if (h > 12) h -= 12; if (h === 0) h = 12; return h + (m !== '00' ? ':' + m : '') + s; }

document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeSidecars(); });
</script>

<script src="/js/nav.js"></script></body>
</html>